--建立科目对照表 
insert into md_km_map_temp
  (facctcode,
   facctname,
   facctlevel,
   facctparent,
   facctdetail,
   facctclass,
   facctattr,
   facctattrid,
   fcurcode,
   fbaldc,
   famount,
   fcarryacc,
   fename,
   fby,
   SRC,
   fset,
   fyear,
   fjjdm,
   c_plan_code,
   c_km_code,
   c_km_name,
   c_km_code_p,
   c_dv_km_cls,
   c_dta_code,
   c_dv_issue_mode,
   c_dv_var_dur,
   c_dv_invest_cls,
   c_port_cls_code,
   c_dai_code,
   c_ca_code,
   c_sec_code,
   c_fee_code,
   c_net_code,
   C_DT_CODE,
   C_MKT_CODE,
   C_SEC_VAR_CODE,
   C_DV_ACC_TYPE,
   C_DC_CODE,
   C_DV_FEE_TYPE,
   C_DS_CODE,
   C_TD_CHAN_CODE,
   C_CAI_CURR,
   N_DETAIL,
   C_DAI_DETAI,
   C_DV_BOOL_TYPE_AM,
   C_DV_JD_WAY,
   C_DV_BOOL_TYPE_AUX,
   C_DESC,
   C_UPDATE_BY,
   C_UPDATE_TIME,
   C_CHECK_BY,
   C_CHECK_TIME,
   C_DVA_ITEM_CODE,
   N_CHECK_STATE,
   N_STATE,
   C_IDEN,
   C_ATTR_CODE)
select a.*, c.fjjdm, d.*
  from md_laccount a
  left join md_cssysjj c
    on c.c_fset = a.c_fset
  left join t_f_sc_km d
    on 1 = 0
  where a.facctcode not in (
     select mkmp.facctcode from md_km_map mkmp
     where a.facctcode = mkmp.facctcode
     and a.c_fset = c.c_fset
     and c.fjjdm = mkmp.fjjdm
     and a.c_year = mkmp.fyear
     and mkmp.C_KM_code is not null
     
  ) and a.facctdetail = 1 
   and a.facctcode in (select distinct fkmh from md_fcwvch f where f.c_fset = c.c_fset and {f.c_year=:year} )
    {and c.fjjdm=:port} {and a.c_year=:year};

update md_km_map_temp set c_plan_code =:c_plan_code where c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--临时处理
update md_km_map_TEMP set FACCTATTR = '其他衍生工具_商品期货_空头' where facctattr = '其他衍生工具_商品期货' and facctcode = '310204010I1409';
--C_DV_KM_CLS 科目类别
update md_km_map_temp set c_dv_km_cls  = case when facctclass = '资产类' then 'KC_ZC' when facctclass = '负债类' then 'KC_FZ' 
 when facctclass = '共同类' then 'KC_GT' when facctclass = '权益类' then 'KC_QY' when facctclass = '损益类' then 'KC_SY' else ' ' end
 WHERE (c_dv_km_cls = '' or c_dv_km_cls is null) and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--先设默认核算项目
update md_km_map_temp set C_DAI_CODE  = ' ' where c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--借贷方向C_DV_JD_WAY(JD_J,JD_D)
update md_km_map_temp set C_DV_JD_WAY  = 'JD_J' WHERE fbaldc = 1 and (C_DV_JD_WAY = '' or C_DV_JD_WAY is null)  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DV_JD_WAY  = 'JD_D' WHERE fbaldc = -1 and (C_DV_JD_WAY = '' or C_DV_JD_WAY is null) and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--更新币种
update md_km_map_temp set c_dc_code = (case when fcurcode = 'RMB' then 'CNY' else fcurcode end) where fcurcode = 'RMB' and c_km_Code is null;

--股票投资交易属性为普通
update md_km_map_temp  set  c_dta_code = 'PT' where facctattr like '%股票投资%' and facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--银行存款、备付金、保证金 （非股指期货）
update md_km_map_temp a set C_DAI_CODE  = 'HBZJ',c_ca_code = fjjdm||'_'|| facctcode
  WHERE (FACCTATTR like '银行存款%' or FACCTATTR like '清算备付金%' or FACCTATTR like '结算保证金%' or FACCTATTR like '交易保证金%') AND  FACCTATTR NOT like '%股指期货%' 
  AND facctclass = '资产类' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
  
  --银行存款、备付金、保证金 （股指期货,国债期货）
update md_km_map_temp a set C_DAI_CODE  = 'HBZJ',c_ca_code = fjjdm||'_'|| facctcode
  WHERE (FACCTATTR like '银行存款%' or FACCTATTR like '清算备付金%' or FACCTATTR like '结算保证金%' or FACCTATTR like '交易保证金%' or FACCTATTR like '存出保证金%') AND  FACCTATTR like '%期货%' 
  AND facctclass = '资产类' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
  
--更新存款类别
update md_km_map_temp a set a.c_dv_acc_type  = (select c_dv_acc_type from T_P_BI_CASH_ACC b where a.c_ca_code = b.c_ca_code) where a.c_dv_acc_type = '' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp a set a.c_dc_code  = (select c_dc_code from T_P_BI_CASH_ACC b where a.c_ca_code = b.c_ca_code) where a.c_dv_acc_type = '' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

--证券投资
update md_km_map_temp set C_DAI_CODE  = 'ZQTZ_CB',C_DV_INVEST_CLS  = 'IC_TD' WHERE FACCTATTR like '%投资%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'ZQTZ_CB',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE ='SS' WHERE FACCTATTR like '%股票投资%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_sec_var_code = 'GP_GP', C_DV_ISSUE_MODE = 'WSS_WS' WHERE  FACCTATTR like '%投资%' AND (FACCTATTR like '%新股%' or FACCTATTR like '%未上市%') AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_sec_var_code = 'GP_GP', C_DV_ISSUE_MODE = 'WSS_WS' WHERE  FACCTATTR like '%股票投资_配股%'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--update md_km_map_temp set C_DV_ISSUE_MODE = 'WSS_WX' WHERE  FACCTATTR like '%投资%网下%' and (FACCTATTR like '%新股%' or FACCTATTR like '%未上市%') AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--股票                          
UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code = 'GP_GP'
                          where a.facctclass = '资产类' AND a.facctattr like '%股票投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

-- 
update md_km_map_temp set C_DV_ISSUE_MODE = 'WSS_WX_FGK' WHERE FACCTATTR like '%投资%非公开%' and (FACCTATTR like '%新股%' or FACCTATTR like '%未上市%') AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DV_INVEST_CLS  = 'IC_TD',C_SEC_VAR_CODE = 'GP_GP' where facctattr like '股票投资_新股%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--估值增值
update md_km_map_temp set C_DAI_CODE  = 'ZQTZ_GYBD' WHERE FACCTATTR like '%投资估值增值%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--股票
UPDATE md_km_map_temp a
   SET a.c_mkt_code =  (case when facctattr like '%深%' then 'XSHE' WHEN FACCTATTR LIKE '%场外%' THEN 'COTC'
                         WHEN FACCTATTR LIKE '%银行%' THEN 'XCFE' ELSE 'XSHG' END)
                          where a.FACCTATTR like '%股票投资%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select b.c_sec_code  from t_p_sv_sec_base b
                        where substr(b.c_sec_code,0,6) = substr(a.facctcode,length(a.facctcode)-5,6) and b.c_sec_var_code like 'GP%' 
                          AND B.C_MKT_CODE = A.C_MKT_CODE and rownum = 1)
                          where a.FACCTATTR like '%股票投资%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code =  nvl((select b.c_Sec_Var_Code   from t_p_sv_sec_base b 
        where b.c_sec_code  = a.c_sec_code and b.c_mkt_code = a.c_mkt_code and c_sec_var_code like 'GP%'),a.c_Sec_Var_Code)
           where  a.facctclass = '资产类' AND  a.FACCTATTR like '%股票投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--债券                
UPDATE md_km_map_temp a SET a.c_mkt_code = case when a.FACCTATTR like '%深圳%' then 'XSHE' when a.FACCTATTR like '%场外%' then 'COTC' 
 when a.FACCTATTR like '%银行间%' then 'XCFE' ELSE 'XSHG' END 
 where a.FACCTATTR like '%债券投资%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'
 where a.FACCTATTR like '%债券投资%票据%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--SP
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE' 
 where a.FACCTATTR like '%债券投资%' AND FACCTCODE LIKE '%128008' AND a.facctclass = '资产类'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};


update md_km_map_temp  set c_dta_code = 'PT',C_DV_ISSUE_MODE = 'SS' where facctattr like '%债券投资%' and c_mkt_code in ('XSHE','XSHG','XCFE') and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
                                                                                                  
UPDATE md_km_map_temp a
   SET a.c_sec_code = (select b.c_sec_code from 
                      (select ba.c_sec_code,ba.c_mkt_code,ba.c_sec_var_code,xx.fzqdm from t_p_sv_sec_base ba  left join md_cszqxx xx 
                       on ba.c_sec_mkt_code = xx.fscdm where ba.c_sec_var_code like 'ZQ%' AND xx.fjjdm = ' ') b
                        where b.fzqdm = substr(a.facctcode,length(a.facctcode)-5,6)
                         AND B.C_MKT_CODE = A.C_MKT_CODE )
                          where a.FACCTATTR like '%债券投资%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--先通过科目性质更新债券品种
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GZXQ' WHERE FACCTATTR like '%债券投资%国债%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_CJZ' WHERE FACCTATTR like '%债券投资%次%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_JRZ' WHERE FACCTATTR like '%债券投资%金融%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KZZ' WHERE FACCTATTR like '%债券投资%转%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KFLZ' WHERE FACCTATTR like '%债券投资%分离%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_SMZQ' WHERE FACCTATTR like '%债券投资%私募%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_DQRZZ' WHERE FACCTATTR like '%债券投资%短期%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZQPJ' WHERE FACCTATTR like '%债券投资%中期%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' WHERE FACCTATTR like '%债券投资%企业%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_YHPJ' WHERE FACCTATTR like '%债券投资%央行%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZCZQH' WHERE FACCTATTR like '%债券投资%资产证券化%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--再通过基本信息修正品种
UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code =  nvl((select b.c_Sec_Var_Code   from t_p_sv_sec_base b 
        where b.c_sec_code  = a.c_sec_code and b.c_mkt_code = a.c_mkt_code and c_sec_var_code like 'ZQ%'),a.c_Sec_Var_Code)
           where  a.facctclass = '资产类' AND  a.FACCTATTR like '%债券投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--基金
UPDATE md_km_map_temp a SET a.c_mkt_Code = case when A.FACCTATTR like '%深圳%' then 'XSHE' when A.FACCTATTR like '%银行间' then 'XCFE' 
 when A.FACCTATTR  like '%开放式%' then 'COTC' when A.FACCTATTR  like '%场外%' then 'COTC' when A.FACCTATTR  like '%LOF%' then 'XSHE' else 'XSHG' END
 where a.FACCTATTR like '%基金投资%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--不适用
--UPDATE md_km_map_temp a SET a.c_Sec_Var_Code = case when a.FACCTATTR like '%ETF' then 'JJ_KFS_ETF' when a.FACCTATTR like '%LOF' then 'JJ_KFS_LOF' 
--	when a.FACCTATTR like '%货币%' then 'JJ_KFS_HBX' when a.FACCTATTR like '%开放式%' then 'JJ_KFS' else 'JJ_FBS' END
--  where a.FACCTATTR like '%基金投资%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--sp特殊
UPDATE md_km_map_temp a SET a.c_Sec_Var_Code = case when a.FACCTname like '%ETF%' then 'JJ_KFS_ETF'  else c_sec_var_code END,
 c_mkt_code = case when a.FACCTname like '%上证%' then 'XSHG' when a.FACCTname like '%深证%' then 'XSHE' 
   when a.FACCTname like '%沪深%' then 'XSHE'  else C_MKT_CODE END 
  where a.FACCTATTR like '%基金投资%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code =  substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
                          where a.FACCTATTR like '%基金投资%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

      
update md_km_map_temp a set a.C_DV_ISSUE_MODE = 'SS',c_dta_code = 'PT' where  a.facctclass = '资产类' AND a.facctattr like '%基金投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--票据投资                         
update md_km_map_temp a set a.c_sec_var_code = 'LC_PJ' where a.facctattr like '%票据投资%' and a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--update md_km_map_temp a set a.c_sec_var_code = 'LC_PJ' where a.facctattr like '%其他投资%' and a.facctname like '%票据投资%' and a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--update md_km_map_temp a set a.c_sec_var_code = 'LC_PJ' where a.facctattr like '%其他应收款%' and a.facctname like '%票据%' and a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--集合理财
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC' ,C_DTA_CODE = 'PT',C_DV_ISSUE_MODE = 'SS',
 a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' OT',c_sec_var_code = 'LC_JH'
 where a.FACCTATTR in('集合理财产品投资','其他投资') AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

                                                              
--信托
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC' ,C_DTA_CODE = 'PT',C_DV_ISSUE_MODE = 'SS'
 where a.FACCTATTR like '%信托投资%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '%信托投资%深圳%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '%信托投资%场外%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '%信托投资%银行间%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

UPDATE md_km_map_temp a
   SET a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' OT'
                         where a.FACCTATTR like '%信托投资%' AND a.facctclass = '资产类' and a.facctlevel = '4' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code = 'LC_XT' where a.c_sec_code <> ' '  AND a.facctclass = '资产类' AND a.facctattr like '%信托投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
                                 

--投资分类C_DV_INVEST_CLS
update md_km_map_temp set C_DV_INVEST_CLS  = 'IC_TD' WHERE C_DAI_CODE = 'ZQTZ_CB' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

-------
--买入返售证券
update md_km_map_temp set C_DAI_CODE  = 'MRFSJRZC' WHERE FACCTATTR like '买入%返售证券%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--买入返售证券_银行间
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHG'  where a.FACCTATTR like '买入%返售证券%'  AND a.facctclass = '资产类' and c_mkt_code is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '买入%返售证券%深圳%'  AND a.facctclass = '资产类'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '买入%返售证券%场外%'  AND a.facctclass = '资产类'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '买入%返售证券%银行间%'  AND a.facctclass = '资产类'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

UPDATE md_km_map_temp a
   SET a.c_sec_code =  substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
        where a.FACCTATTR like '%买入%返售证券%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code =  case when a.facctattr like '%买断式%' then 'HG_MDS' else 'HG_ZYS' end
     where a.c_sec_code <> ' '  AND a.facctclass = '资产类' AND a.facctattr like '%买入%返售证券%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
                                                    
--更新委贷投资的核算项目
--update md_km_map_temp set c_dai_code = 'HBZC_CK',C_SEC_VAR_CODE = 'DK_DQ',C_SEC_CODE = fjjdm || '_' || facctcode || ' OT'  WHERE FACCTNAME like '%委%贷%' and facctattr like '其他应收款' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_DAI_CODE  = 'YSLX' WHERE FACCTATTR like '%应收利息%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--更新 应收利息－现金(保证金) 的 核算项、账户代码
update md_km_map_temp a set C_DAI_CODE  = 'YSLX_ZJ' ,C_MKT_CODE = '' , c_ca_code = fjjdm || '_' ||
   (select distinct regexp_substr(fvchzy,'[0-9]+',12,1) fkmdm
                       from md_fcwvch b
                      where b.fkmh = a.facctcode and b.c_year=a.fyear and b.fzqjyfs = 'JX'
                        and b.c_fset =  a.fset and b.fpzly = 'FYHJX' and rownum =1)
 WHERE (FACCTATTR like '%应收利息%金%' or FACCTATTR = '应收利息' or FACCTATTR = '应收利息_活期存款')
   AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--更新 应收利息_证券 市场代码
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHG'  where a.FACCTATTR like '%应收利息%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '%应收利息%深圳%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '%应收利息%银行间%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '%应收利息%场外%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = ''  where a.FACCTATTR like '%应收利息%存款'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.c_mkt_code = '' where a.FACCTATTR like '应收利息' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.c_mkt_code = '' where a.FACCTATTR like '应收利息%保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--更新存款类别
update md_km_map_temp a set a.c_dv_acc_type  = (select c_dv_acc_type from T_P_BI_CASH_ACC b where a.c_ca_code = b.c_ca_code) 
where a.c_ca_code <> ' '  and facctattr like '%应收利息%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--根据现金账户代码更新账记类型
update md_km_map_temp a
   set a.C_DV_ACC_tYPE  =
       (select C_DV_ACC_tYPE 
          from T_P_BI_CASH_ACC  b
         where b.c_ca_code = a.c_ca_code
  ) where NVL(C_CA_CODE,' ') <> ' ' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
--应收申购款
update md_km_map_temp set C_DAI_CODE  = 'YSK_SGK',c_ds_code = 'TAXS_SG' 
 WHERE FACCTATTR = '应收申购款' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSK_SGK',c_ds_code = 'TAXS_ZR' 
 WHERE FACCTATTR = '应收申购款_转入' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--应收利息_证券
update md_km_map_temp 
 set C_DAI_CODE  = 'YSLX_ZQ',c_dv_invest_cls = 'IC_TD',C_DV_ISSUE_MODE = 'SS',c_dta_code = 'PT' WHERE (FACCTATTR  LIKE '应收利息_%债%' or FACCTATTR  LIKE '应收利息_%票据%' 
 or FACCTATTR  LIKE '应收利息_%资产证券化%')  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
 update md_km_map_temp 
 set C_DAI_CODE  = 'YSLX_ZQ' WHERE (FACCTATTR  LIKE '应收利息_%回购%'  or FACCTATTR  LIKE '应收利息_%债%' or FACCTATTR  LIKE '应收利息_%票据%' 
 or FACCTATTR  LIKE '应收利息_%资产证券化%')  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

UPDATE md_km_map_temp a
   SET a.c_sec_code =  substr(a.facctcode,length(a.facctcode)-5,6) ||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
         where a.FACCTATTR like '%应收利息_%回购%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--sp
UPDATE md_km_map_temp a   SET a.c_sec_code =  'R001 CY'
         where a.FACCTATTR like '%回购_银行间%' AND FACCTCODE LIKE '%00001' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};


UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code =  (select b.c_Sec_Var_Code 
                         from t_p_sv_sec_base b 
                        where b.c_sec_code  = a.c_sec_code and b.c_mkt_code = a.c_mkt_code and c_sec_var_code like 'HG%')
                       where a.c_sec_code <> ' '  AND a.facctclass = '资产类' AND  a.FACCTATTR like '%应收利息_%回购%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6) ||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
      where(  a.FACCTATTR like '%应收利息_%债%' or FACCTATTR  LIKE '应收利息_%票据%' or FACCTATTR  LIKE '应收利息_%资产证券化%')
         AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GZXQ' WHERE FACCTATTR like '应收利息%国债%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_CJZ' WHERE FACCTATTR like '应收利息%次%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_JRZ' WHERE FACCTATTR like '应收利息%金融%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KZZ',c_dta_code = 'PT', C_DV_ISSUE_MODE = 'SS'    WHERE FACCTATTR like '应收利息%转%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KFLZ' WHERE FACCTATTR like '应收利息%分离%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_SMZQ' WHERE FACCTATTR like '应收利息%私募%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_DQRZZ' WHERE FACCTATTR like '应收利息%短期%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZQPJ' WHERE FACCTATTR like '应收利息%中期%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QTZ' WHERE FACCTATTR like '应收利息%其他%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' ,c_dta_code = 'PT',C_DV_ISSUE_MODE = 'SS'  WHERE FACCTATTR like '应收利息%企业%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DV_ISSUE_MODE = 'WSS_WS'  WHERE FACCTATTR like '应收利息%未%企业%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_YHPJ' WHERE FACCTATTR like '应收利息%央行%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZCZQH' WHERE FACCTATTR like '应收利息%资产证券化%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='HG_ZYS' WHERE FACCTATTR like '应收利息%回购%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='HG_MDS' WHERE FACCTATTR like '应收利息%买断式回购%'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
       
--债券溢折价
update md_km_map_temp set C_DAI_CODE  = 'ZQTZ_YZJ',c_dv_inveSt_cls = 'IC_FS', c_dv_issue_mode='SS',C_SEC_VAR_cODE = 'ZQ' WHERE (FACCTATTR like '%溢折价%' ) AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHG'  where a.FACCTATTR like '%溢折价%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '%溢折价%深圳%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '%溢折价%银行间%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '%溢折价%场外%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
                          where a.FACCTATTR like '%溢折价%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--临时将未作细分的溢折价债券设为上交所企业债
UPDATE MD_KM_MAP_TEMP SET C_SEC_VAR_cODE = 'ZQ_QYZ' where facctattr like '溢折价_债券投资'
 AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
                          
--应收股利
update md_km_map_temp set C_DAI_CODE  = 'YSK_GL',c_mkt_code ='XSHG',C_SEC_VAR_CODE ='GP',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'  WHERE FACCTATTR like '应收股利' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YSK_GL',c_mkt_code ='XSHE',C_SEC_VAR_CODE ='GP' WHERE FACCTATTR like '应收股利_%深圳' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='GP_GP' WHERE FACCTATTR like '%应收股利%' and FACCTATTR not like '%创业板%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='GP_GP_CYB' WHERE FACCTATTR like '%应收股利%创业板%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp A set C_DAI_CODE  = 'YSLX_ZQ',c_mkt_code ='COTC',C_SEC_VAR_CODE ='LC_JH',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS' ,
 C_SEC_CODE = substr(a.facctcode,length(a.facctcode)-5,6)||' OTC'
  WHERE FACCTATTR like '应收集合理财产品红利' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

                         
--应收基金红利_开放式_货币基金
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHG',c_sec_var_code = 'JJ_FBS',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'  where a.FACCTATTR like '%应收基金红利%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '%应收基金红利%深圳%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '%应收基金红利%银行间%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '%应收基金红利%场外%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC',c_sec_var_code = 'LC_XT',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS' ,
 C_SEC_CODE = substr(a.facctcode,length(a.facctcode)-5,6)||' OT',C_DAI_CODE = 'YSK_GL'
  where a.FACCTATTR like '%应收信托红利%'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
       where a.FACCTATTR = '应收基金红利_开放式_货币基金'  AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a SET a.c_Sec_Var_Code =  'JJ_KFS_HBX'   where a.c_sec_code <> ' ' 
   and a.facctclass = '资产类' and a.FACCTATTR like '应收基金红利_开放式_货币基金' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
update md_km_map_temp set C_DAI_CODE  = 'YSK_GL', C_MKT_CODE  = 'XSHG' WHERE FACCTATTR like '应收基金红利%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_MKT_CODE  = 'XSHE' WHERE FACCTATTR like '应收基金红利%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_MKT_CODE  = 'COTC' WHERE FACCTATTR like '应收基金红利%开放式%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code =  substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
      where a.FACCTATTR like '%应收基金红利_%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code = CASE WHEN A.FACCTATTR LIKE '%开放式' THEN 'JJ_KFS' WHEN A.FACCTATTR LIKE '%货币基金' tHEN 'JJ_KFS_HBX' WHEN A.FACCTATTR LIKE '%ETF' tHEN 'JJ_KFS_ETF' ELSE 'JJ_KFS' END
       where  a.facctclass = '资产类' and a.FACCTATTR like '%应收基金红利%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
       
UPDATE md_km_map_temp a SET a.c_Sec_Var_Code =  'JJ_FBS'   where a.facctname like '%封闭%'
   and a.facctclass = '资产类' and a.FACCTATTR like '应收基金红利%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_Sec_Var_Code =  nvl((select b.c_Sec_Var_Code   from t_p_sv_sec_base b 
        where b.c_sec_code  = a.c_sec_code and b.c_mkt_code = a.c_mkt_code and c_sec_var_code like 'JJ%' AND C_SEC_VAR_CODE NOT LIKE '%LOF%'),a.c_Sec_Var_Code)
           where  a.facctclass = '资产类' AND  a.FACCTATTR like '%基金投资%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--其他应收款
update md_km_map_temp set C_DAI_CODE  = 'YSK_QTK' WHERE FACCTATTR like '其他应收款' and FACCTNAME LIKE '%其他%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where a.facctname like b.c_fee_name || '%' ) where facctattr = '其他应收款' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where b.c_fee_name like a.facctname  || '%') where facctattr = '其他应收款' and a.C_FEE_CODE is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_FEE_CODE  = 'QTL_ZQLX' WHERE FACCTATTR like '其他应收款%利息%'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_FEE_CODE  = 'QTL_QT' WHERE FACCTATTR like '其他应收款%' and C_FEE_CODE IS NULL AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--负债类
--卖出回购证券款
update md_km_map_temp set C_DAI_CODE  = 'MCHGJRZC' ,
 c_sec_var_code =case when facctattr like '%买断式%' then 'HG_MDS' else 'HG_ZYS' end
   WHERE FACCTATTR like '卖出%回购证券款%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};                            

UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHG'  where a.FACCTATTR like '%卖出%回购证券款%'  AND a.facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XSHE'  where a.FACCTATTR like '%卖出%回购证券款%深圳%'  AND a.facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a SET a.c_mkt_code = 'XCFE'  where a.FACCTATTR like '%卖出%回购证券款%银行间%'  AND a.facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
UPDATE md_km_map_temp a SET a.c_mkt_code = 'COTC'  where a.FACCTATTR like '%卖出%回购证券款%场外%'  AND a.facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code =  substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END),
   a.c_sec_var_code =case when a.facctattr like '%买断式%' then 'HG_MDS' else 'HG_ZYS' end
     where a.FACCTATTR like '%卖出%回购证券款%' AND a.facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
                          
--应付利息
--应付利息_回购
update md_km_map_temp set C_DAI_CODE  = 'YFLX_ZQ',C_SEC_VAR_CODE ='HG_ZYS',C_MKT_CODE ='XSHG' WHERE FACCTATTR like '应付利息%回购' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--应付利息_回购_深圳
update md_km_map_temp set C_DAI_CODE  = 'YFLX_ZQ',C_SEC_VAR_CODE ='HG_ZYS',C_MKT_CODE ='XSHE'  WHERE FACCTATTR like '应付利息%回购%深圳' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--应付利息_回购_银行间
update md_km_map_temp set C_DAI_CODE  = 'YFLX_ZQ',C_SEC_VAR_CODE ='HG_ZYS',C_MKT_CODE ='XCFE'  WHERE FACCTATTR like '应付利息%回购%银行间' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--应付利息更新C_SEC_CODE
update md_km_map_temp a set C_SEC_CODE  = substr(a.facctcode,length(a.facctcode)-5,6)||' '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END) WHERE FACCTATTR like '应付利息%回购%' 
    and length(a.facctcode)=14 AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set C_SEC_CODE  = 'HG9999 '||(case when a.c_mkt_code = 'XSHG' THEN 'SH' when a.c_mkt_code = 'XSHE' THEN 'SZ'
   when a.c_mkt_code = 'XCFE' THEN 'CY' when a.c_mkt_code = 'COTC' THEN 'OT' ELSE ' ' END)
  WHERE FACCTATTR like '应付利息%回购%' 
    and length(a.facctcode)=8 AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--应付交易费用  应付交易费用_结算服务费_债券
--应付交易费用_结算服务费（默认为债券）
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JSFWF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '应付交易费用_结算服务费%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_结算服务费_债券
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JSFWF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '应付交易费用_结算服务费_债券%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_结算服务费_回购
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JSFWF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'HG'  WHERE FACCTATTR like '应付交易费用_结算服务费_回购%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_交易手续费_债券
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JYSXF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'ZQ'  WHERE FACCTATTR like '应付交易费用_交易手续费%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_债券交易费_银行间
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JYSXF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'ZQ'  WHERE FACCTATTR like '应付交易费用_债券交易费_银行间%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_回购交易费_银行间
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JYSXF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'HG'  WHERE FACCTATTR like '应付交易费用_回购交易费_银行间%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--应付交易费用_交易手续费_回购
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_JY',C_FEE_CODE='ZQL_JYSXF',C_MKT_CODE ='XCFE' ,C_SEC_VAR_CODE = 'HG'  WHERE FACCTATTR like '应付交易费用_交易手续费_回购%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--上清所应付交易费
update md_km_map_temp set C_MKT_CODE ='SHCH'   WHERE FACCTATTR like '应付交易费用_%上清所%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--应付交易费用_交易手续费_债券

--应付佣金(应付交易费用_佣金)
update md_km_map_temp set C_DAI_CODE  = 'YFK_FY_YJ' WHERE FACCTATTR like '应付佣金' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp a set C_TD_CHAN_CODE  = (select c_rela_code from t_p_ab_port_rela c join t_p_ab_td_chan  b on c.c_rela_code = b.c_td_chan_code
 where C.c_port_code = a.fjjdm and b.c_mkt_code = case when a.facctname like '%深圳%' then 'XSHE' ELSE 'XSHG' END and instr(substr(facctcode,9),c_rela_code) > 0)
 WHERE FACCTATTR like '应付佣金' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--UPDATE T_D_AI_ACT_VAL SET C_DAI_CODE = 'YFK_FY_YJ' WHERE  C_DAI_CODE = 'YFK_FYYJ';

--应付运营费用
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_GLF' WHERE FACCTATTR like '应付管理人报酬' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_GLF' WHERE FACCTATTR like '应付管理人报酬_管理费' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_YJBCF' WHERE FACCTATTR like '应付管理人报酬_业绩报酬' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YFL_FXJ' WHERE FACCTATTR like '应付管理人报酬_风险准备金' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_TGF' WHERE FACCTATTR like '应付托管费' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_XSF',C_PORT_CLS_CODE = regexp_substr(facctname,'[0-9]+',1,1) WHERE FACCTATTR like '应付销售费' AND FACCTNAME LIKE '%级%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--应付销售费
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_XSF' WHERE FACCTATTR like '应付销售费' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',C_FEE_CODE = 'YYL_YYFWF' WHERE FACCTNAME like '%运营服务费' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--应付赎回款
update md_km_map_temp set C_DAI_CODE  = 'YFK_SHK',C_DS_CODE = 'TAXS_SH' WHERE FACCTATTR like '应付赎回款%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DS_CODE = 'TAXS_ZC' WHERE FACCTATTR like '应付赎回款_转出%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--应付赎回费
update md_km_map_temp set C_DAI_CODE  = 'YFK_SHF',C_DS_CODE = 'TAXS_SH' WHERE FACCTATTR like '应付赎回费%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DS_CODE = 'TAXS_ZC' WHERE FACCTATTR like '应付赎回费_转出%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YFK_SHF',C_DS_CODE = 'TAXS_SG' WHERE facctname like '应付后端申购费%' AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--其他应付款
update md_km_map_temp set C_DAI_CODE  = 'YFK_QTK' WHERE FACCTATTR like '%其他应付款%'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_FEE_CODE  = 'YFL_FXJ' WHERE FACCTATTR like '其他应付款_风险准备金'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where a.facctname like b.c_fee_name || '%' ) where facctattr = '其他应付款' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where b.c_fee_name like a.facctname  || '%') where facctattr = '其他应付款' and a.C_FEE_CODE is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YFK_QTK' WHERE FACCTATTR like '%其他应付款%'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YFK_QTK' WHERE FACCTATTR like '%其他应付款%'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YFK_QTK',c_fee_code ='YYL_ZSSYF' WHERE FACCTATTR like '%其他应付款_指数使用费%'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YFK_YYF',c_fee_code = 'YYL_ZCFWF' WHERE FACCTATTR ='其他应付款_资产服务费'  AND facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--没有匹配上的放入科目“其他应付款_其他”
update md_km_map_temp a set a.C_FEE_CODE  = 'QTL_QT' where facctattr like '%其他应付款%' and a.C_FEE_CODE is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--应付收益
update md_km_map_temp set c_dai_code = 'YFK_LR' where facctattr like '%应付收益%'  and facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_port_cls_code= regexp_substr(facctname,'[0-9]+',1,1) where facctattr like '%应付收益%' and facctname like '%级%' and facctclass = '负债类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--共同类
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 
(CASE WHEN FACCTNAME LIKE '上%' then 'XSHG' WHEN FACCTNAME LIKE '深%' then 'XSHE' ELSE '' END) WHERE FACCTATTR like '证券清算款%' 
 AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--证券清算款_深圳
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 'XSHE' WHERE FACCTATTR like '证券清算款_深圳' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 'XSHE' WHERE FACCTATTR like '证券清算款_T+2清算_深圳' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

--证券清算款_上海
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 'XSHG' WHERE FACCTATTR = '证券清算款_上海' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--证券清算款_场外(银行间)
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 'COTC' WHERE FACCTATTR like '证券清算款_场外%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'XCFE' WHERE FACCTATTR like '证券清算款_场外_应收债券利息' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--证券清算款_期货
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK',C_MKT_CODE = 'CCFX' WHERE FACCTATTR like '证券清算款_%期货' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--证券清算款_新股_深圳
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'XSHE' WHERE FACCTATTR = '证券清算款_新股_深圳' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--证券清算款_新股_上海
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'XSHG' WHERE FACCTATTR = '证券清算款_新股_上海' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--证券清算款_非T+1清算_
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'XSHG' WHERE FACCTATTR = '证券清算款_非T+1清算_上海' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'COTC' WHERE FACCTATTR like '证券清算款_非T+1清算_场外%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'XSHE' WHERE FACCTATTR like '证券清算款_非T+1清算_深圳%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'COTC' WHERE FACCTATTR like '证券清算款_场外_应收新股申购款' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'COTC' WHERE FACCTATTR like '证券清算款_场外_应收开放式基金%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_SQK',C_MKT_CODE = 'COTC' WHERE FACCTATTR like '证券清算款_场外_应收债券%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_dai_code  = 'ZQQSK_SQK',c_mkt_code = 'COTC' WHERE FACCTATTR='证券清算款_场外_应收开放式基金申购款' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DS_CODE = 'TAXS_SG' WHERE FACCTATTR LIKE '证券清算款_场外%申购%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DS_CODE = 'TAXS_SH' WHERE FACCTATTR LIKE '证券清算款_场外%赎回%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--证券清算款_场外_应收新股申购款
--证券清算款设置市场代码
update md_km_map_temp set C_MKT_CODE  = 'XSHG' WHERE FACCTATTR = '证券清算款' AND FACCTNAME LIKE '上%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE  = 'XSHG' WHERE FACCTATTR = '证券清算款' AND FACCTNAME LIKE '深%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE  = 'XDCE' WHERE FACCTATTR = '证券清算款_商品期货_大连' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE  = 'XZCE' WHERE FACCTATTR = '证券清算款_商品期货_郑州' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--衍生工具
update md_km_map_temp set c_mkt_code = 'CCFX' WHERE FACCTATTR like '%其他衍生工具%'  AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE = 'QH_GZ' WHERE FACCTATTR <> '证券清算款_股指期货' AND FACCTATTR NOT LIKE '%证券清算款%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CB' WHERE FACCTATTR in('其他衍生工具_股指期货_多头','其他衍生工具_股指期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CDCB' WHERE FACCTATTR like '其他衍生工具_股指期货_冲抵%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_GYBD' WHERE FACCTATTR in('投资估值增值_其他衍生工具_股指期货_多头','投资估值增值_其他衍生工具_股指期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_BUY' WHERE FACCTATTR like '%股指期货%多头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL' WHERE FACCTATTR like '%股指期货%空头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE = 'QH_GZ',C_MKT_CODE = 'CCFX'  WHERE FACCTATTR like '%其他衍生工具%股指期货%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE = 'QH_QHGZ',C_MKT_CODE = 'CCFX'  WHERE FACCTATTR like '%其他衍生工具%国债期货%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE = 'QH_QHGZ' WHERE FACCTCODE like '%TF____' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--update md_km_map_temp set C_SEC_VAR_CODE = 'QH_QHGZ' WHERE FACCTATTR <> '证券清算款_国债期货' AND FACCTATTR NOT LIKE '%证券清算款%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CB' WHERE FACCTATTR in('其他衍生工具_国债期货_多头','其他衍生工具_国债期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CDCB' WHERE FACCTATTR like '其他衍生工具_国债期货_冲抵%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_GYBD' WHERE FACCTATTR in('投资估值增值_其他衍生工具_国债期货_多头','投资估值增值_其他衍生工具_国债期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_BUY' WHERE FACCTATTR like '%国债期货%多头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL' WHERE FACCTATTR like '%国债期货%空头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_SEC_VAR_CODE = 'QH_SP' WHERE FACCTATTR like '%其他衍生工具_商品期货%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CB' WHERE FACCTATTR in('其他衍生工具_商品期货_多头','其他衍生工具_商品期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_CDCB' WHERE FACCTATTR like '其他衍生工具_商品期货_冲抵%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'YSGJ_GYBD' WHERE FACCTATTR in('投资估值增值_其他衍生工具_商品期货_多头','投资估值增值_其他衍生工具_商品期货_空头') AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_BUY' WHERE FACCTATTR like '%商品期货%多头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL' WHERE FACCTATTR like '%商品期货%空头%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp a set c_mkt_code = (select c_mkt_code from t_p_sv_sec_base b 
 where b.c_sec_mkt_code = substr(a.facctcode,-6) and b.c_sec_var_code = 'QH_SP') WHERE FACCTATTR LIKE '%其他衍生工具_商品期货%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp a set c_mkt_code = (select c_mkt_code from t_p_sv_sec_base b 
 where b.c_sec_mkt_code = substr(a.facctcode,-5) and b.c_sec_var_code = 'QH_SP') WHERE FACCTATTR LIKE '%其他衍生工具_商品期货%' and c_mkt_code is null AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select b.c_sec_code  from t_p_sv_sec_base b
                        where substr(b.c_sec_code,0,6) = substr(a.facctcode,length(a.facctcode)-5,6) and b.c_sec_var_code like 'QH%' 
                          AND B.C_MKT_CODE = A.C_MKT_CODE)
                          where a.FACCTATTR like '%其他衍生工具%' AND LENGTH(A.FACCTCODE)=14 AND a.facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select b.c_sec_code  from t_p_sv_sec_base b
                        where '0'||substr(b.c_sec_code,0,5) = substr(a.facctcode,length(a.facctcode)-5,6) and b.c_sec_var_code like 'QH%'  AND B.C_MKT_CODE = A.C_MKT_CODE)
                          where a.FACCTATTR like '%其他衍生工具%' and c_sec_code is null AND LENGTH(A.FACCTCODE)=14 AND a.facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};


--资本公积
UPDATE MD_KM_MAP_TEMP SET C_DAI_CODE = 'ZBGJ' WHERE FACCTNAME = '资本公积' AND FACCTATTR = '普通科目' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--实收资本
update md_km_map_temp set C_DAI_CODE  = 'SSZB' ,c_port_cls_code = case when (facctname like '%20%' OR facctname like '%21%') then substr(facctname,-6) else '' end
 WHERE FACCTATTR like '实收资本' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--update md_km_map_temp set C_DAI_CODE  = 'SSZB' ,c_port_cls_code = regexp_substr(facctname,'[0-9]+',1,1) WHERE FACCTATTR like '实收基金%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--update md_km_map_temp set C_DAI_CODE  = 'SSZB' ,c_port_cls_code = regexp_substr(facctname,'[0-9]+',1,1) WHERE FACCTATTR like '实收年金%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--实收资本_份额调整
update md_km_map_temp set C_DAI_CODE  = 'SSZB_FETZ' WHERE FACCTATTR like '基金份额折算调整%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--本年利润
update md_km_map_temp set C_DAI_CODE  = 'BNLR' WHERE FACCTATTR like '本期收益' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'BNLR_YSX',c_port_cls_code = regexp_substr(facctname,'[0-9]+',1,1) WHERE FACCTATTR like '本期收益_已实现' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'BNLR_WSX',c_port_cls_code = regexp_substr(facctname,'[0-9]+',1,1) WHERE FACCTATTR like '本期收益_未实现' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set c_port_cls_code = case when (facctname like '%20%' OR facctname like '%21%') then substr(facctname,-6) else '' end WHERE FACCTATTR like '本期收益%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--损益平准金
--损益平准金_已实现
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_YSX' WHERE FACCTATTR like '损益平准金_已实现%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_YSX',c_ds_code = 'TAXS_SH' WHERE FACCTATTR like '损益平准金_已实现_赎回' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_YSX',c_ds_code = 'TAXS_SG' WHERE FACCTATTR like '损益平准金_已实现_申购' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_YSX',c_ds_code = 'TAXS_SH' WHERE FACCTATTR like '损益平准金_已实现_提取' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_YSX',c_ds_code = 'TAXS_SG' WHERE FACCTATTR like '损益平准金_已实现_追加' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--损益平准金_未实现
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_WSX' WHERE FACCTATTR like '损益平准金_未实现%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_WSX',c_ds_code = 'TAXS_SH' WHERE FACCTATTR like '损益平准金_未实现_赎回' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_WSX',c_ds_code = 'TAXS_SG' WHERE FACCTATTR like '损益平准金_未实现_申购' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_WSX',c_ds_code = 'TAXS_SG' WHERE FACCTATTR like '损益平准金_未实现_追加' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'SYPZJ_WSX',c_ds_code = 'TAXS_SH' WHERE FACCTATTR like '损益平准金_未实现_提取' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set c_ds_code = 'TAXS_ZR' WHERE FACCTATTR like '损益平准金%转入%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set c_ds_code = 'TAXS_ZC' WHERE FACCTATTR like '损益平准金%转出%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
UPDATE MD_KM_MAP_TEMP SET c_port_cls_code = case when (facctname like '%20%' OR facctname like '%21%') then substr(facctname,-6) else '' end
  WHERE FACCTATTR like '损益平准金%' AND facctclass = '权益类' AND LENGTH(FACCTCODE)=14 and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--未分配收益
--利润分配_未分配利润_已实现
update md_km_map_temp set C_DAI_CODE  = 'LRFP_WFP_YSX',c_port_cls_code = regexp_substr(facctname,'[0-9]+',1,1)
 WHERE FACCTATTR like '收益分配_未分配收益_已实现%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--利润分配_未分配利润_未实现
update md_km_map_temp set C_DAI_CODE  = 'LRFP_WFP_WSX' ,c_port_cls_code = CASE WHEN LENGTH(FACCTCODE)=14 THEN  substr(facctname,-6) ELSE '' END
 WHERE FACCTATTR like '收益分配_未分配收益_未实现%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--收益分配_应付收益
update md_km_map_temp set C_DAI_CODE  = 'LRFP_YFLR' WHERE FACCTATTR like '收益分配_应付收益' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set c_port_cls_code = case when (facctname like '%20%' OR facctname like '%21%') then substr(facctname,-6) else '' end WHERE FACCTATTR like '收益分配%' AND facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 


--投资收益
--投资估值损益
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='GP_GP' ,c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS' WHERE FACCTATTR like '投资估值损益' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='GP_GP' , C_MKT_CODE ='XSHG' ,c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS' WHERE FACCTATTR like '投资估值损益_股票投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='ZQ_QYZ',C_MKT_CODE ='XSHG' ,c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'  WHERE FACCTATTR like '投资估值损益_债券投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='ZQ_ZCZQH',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'  WHERE FACCTATTR like '投资估值损益_资产证券化投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='JJ_KFS',c_dta_code = 'PT', C_DV_ISSUE_MODE = 'SS',C_DV_INVEST_CLS  = 'IC_TD'  WHERE FACCTATTR like '投资估值损益_基金投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='QZ'  WHERE FACCTATTR like '投资估值损益_权证投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--update md_km_map_temp set C_MKT_CODE = 'CCFX'  WHERE FACCTATTR like '投资估值损益%期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='QH_SP'  WHERE FACCTATTR like '投资估值损益_商品期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='QH_GZ'  WHERE FACCTATTR like '投资估值损益_股指期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='QH_QHGZ'  WHERE FACCTATTR like '投资估值损益_国债期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'GYBD',C_SEC_VAR_CODE ='LC'  WHERE FACCTATTR like '投资估值损益_信托投资' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set C_DAI_CODE = 'GYBD' WHERE FACCTATTR like '投资估值损益_股指期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_BUY' WHERE FACCTATTR like '投资估值损益_%期货_多头%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL' WHERE FACCTATTR like '投资估值损益_%期货_空头%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_DAI_CODE = 'GYBD' WHERE FACCTATTR like '投资估值损益_国债期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_BUY' WHERE FACCTATTR like '投资估值损益_国债期货_多头%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL' WHERE FACCTATTR like '投资估值损益_国债期货_空头%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_MKT_CODE  = 'XSHG' WHERE FACCTATTR like '投资估值损益%' and FACCTATTR not like '%期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE  = 'XSHE' WHERE FACCTATTR like '投资估值损益%深圳%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set c_dai_code ='GYBD',  c_dta_code = 'XY',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS',C_SEC_VAR_CODE ='GP_GP' WHERE FACCTATTR like '投资估值损益%信用证券账户%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--可退替代款
update md_km_map_temp set C_DAI_CODE  = 'ZQTZ_GYBD',C_SEC_VAR_CODE = 'GP_GP', C_MKT_CODE  = 'XSHG' ,c_dta_code = 'PT', C_DV_ISSUE_MODE = 'SS' WHERE FACCTATTR like '%投资估值增值_可退替代款%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'GYBD_KTTD',C_MKT_CODE='' WHERE FACCTATTR like '%投资估值损益_可退替代款%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'ZQQSK_KTTD',C_FEE_CODE='',C_SEC_VAR_CODE='' WHERE FACCTATTR like '%其他应付款_可退替代款%' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  


--差价收入
--上交所
update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='GP', C_MKT_CODE ='XSHG' ,c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS' WHERE FACCTATTR like '%差价收入%' AND  FACCTATTR like '%股票%'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='GP', C_MKT_CODE ='XSHE' WHERE FACCTATTR like '%差价收入%' AND FACCTATTR like '%股票%深圳'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='GP_GP' WHERE FACCTATTR like '%股票%差价收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set c_dta_code = 'ZS' WHERE FACCTATTR like '%股票%差价收入%指数%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};   

update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='ZQ', C_DV_INVEST_CLS  = 'IC_TD',c_dta_code = 'PT',C_DV_ISSUE_MODE = 'SS',C_MKT_CODE ='XSHG' WHERE FACCTATTR like '债券差价收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_MKT_CODE ='XSHE' WHERE FACCTATTR like '债券差价收入%深圳%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_MKT_CODE ='XCFE' WHERE FACCTATTR like '债券差价收入%银行间%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KZZ' WHERE FACCTATTR like '债券差价收入%可转换债券%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GSZ' WHERE FACCTATTR like '债券差价收入%' AND FACCTNAME LIKE '%国%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' WHERE FACCTATTR like '债券差价收入%' AND FACCTNAME LIKE '%企%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
 

update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='JJ_KFS', C_DV_INVEST_CLS  = 'IC_TD',c_dta_code = 'PT',C_DV_ISSUE_MODE = 'SS',c_mkt_code = 'XSHG' WHERE FACCTATTR like '基金差价收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set c_mkt_code = 'XSHE' WHERE FACCTATTR like '基金差价收入%深圳%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='LC', C_DV_INVEST_CLS  = 'IC_TD' WHERE FACCTATTR like '信托差价收入%' AND FACCTATTR like '%信托%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='PJ', C_DV_INVEST_CLS  = 'IC_TD' WHERE FACCTATTR like '投资收益%' AND FACCTname like '%票据%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'TZSY_CJSR',C_SEC_VAR_CODE ='QZ', C_DV_INVEST_CLS  = 'IC_TD',
 c_mkt_code = case when facctattr like '%深圳%' then 'XSHE' else 'XSHG' END 
 WHERE FACCTATTR like '权证损益%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--股利收入
update md_km_map_temp set C_DAI_CODE  = 'TZSY_HLSR',C_SEC_VAR_CODE ='GP',C_MKT_CODE  ='XSHG',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'  WHERE FACCTATTR like '%股利收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'TZSY_HLSR',C_SEC_VAR_CODE ='GP',C_MKT_CODE  ='XSHE'  WHERE FACCTATTR like '%股利收入_%深圳%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='GP_GP' WHERE FACCTATTR like '股利收入' or FACCTATTR like '股利收入_深圳' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_SEC_VAR_CODE ='GP_GP_CYB' WHERE FACCTATTR like '股利收入%创业板%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  


update md_km_map_temp set C_DAI_CODE  = 'TZSY_HLSR',C_SEC_VAR_CODE ='LC_XT',C_MKT_CODE = 'COTC',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'   WHERE FACCTATTR like '%信托%红利收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'TZSY_HLSR',C_SEC_VAR_CODE ='LC_XT',C_MKT_CODE = 'COTC',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'   WHERE FACCTATTR like '%理财%红利收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'TZSY_HLSR',C_SEC_VAR_CODE ='JJ_KFS',C_MKT_CODE = 'XSHG',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS'   WHERE FACCTATTR like '基金红利收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_MKT_CODE ='XSHE'   WHERE FACCTATTR like '基金红利收入%深圳%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set C_DAI_CODE = 'LXSR_ZQ',c_sec_var_code = 'LC_JH'  WHERE FACCTATTR = '集合理财产品红利收入' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--利息收入
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZJ',C_DV_ACC_TYPE = 'ACC_SAV' WHERE FACCTATTR like '%存款利息收入%'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZJ',C_DV_ACC_TYPE = 'ACC_EX_RES' WHERE FACCTATTR like '%利息收入%' and facctname like '%备付金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZJ',C_DV_ACC_TYPE = 'ACC_TD_BAIL' WHERE FACCTATTR like '%利息收入%' and facctname like '%保证金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZJ',C_CA_CODE='16' WHERE FACCTATTR like '利息收入_交易保证金' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--利息收入_销售
update md_km_map_temp set C_DAI_CODE  = 'LXSR_TA',c_ds_code ='TAXS_SG' 
 WHERE FACCTATTR like '%利息收入%' AND FACCTNAME LIKE '%申购款%' AND FACCTATTR NOT LIKE '存款利息收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--委贷利息收入
--委托贷款利息收入
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ',c_sec_var_code='DK' WHERE FACCTATTR like '利息收入' and facctname like '%委%贷%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--债券利息收入
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ',C_SEC_VAR_CODE ='ZQ',c_dta_code = 'PT',C_DV_INVEST_CLS  = 'IC_TD',C_DV_ISSUE_MODE = 'SS',c_mkt_code='XSHG' WHERE FACCTATTR like '债券利息收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' WHERE FACCTATTR like '债券利息收入%' and facctname like '%企%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GSZ' WHERE FACCTATTR like '债券利息收入%' and facctname like '%国%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--定存利息收入
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ',C_SEC_VAR_CODE ='CK_DQ',C_MKT_CODE ='COTC',C_DV_ACC_TYPE = '' WHERE FACCTATTR = '存款利息收入_定期存款' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ',C_SEC_VAR_CODE ='CK_XY',C_MKT_CODE ='COTC',C_DV_ACC_TYPE = '' WHERE FACCTATTR = '存款利息收入_协定存款' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--更新市场代码
update md_km_map_temp set  
c_mkt_code = (case when facctname like '%上海%' then 'XSHG'
when facctname like '%深圳%' then 'XSHE'
when facctname like '%银行%' then 'XCFE'
when facctname like '%央行%' then 'XCFE'
  else c_mkt_code
    end
) WHERE FACCTATTR like '债券利息收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--更新债券品种
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GZXQ' WHERE FACCTATTR like '债券利息收入%国债%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_CJZ' WHERE FACCTATTR like '债券利息收入%次%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_JRZ' WHERE FACCTATTR like '债券利息收入%金融%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KZZ' WHERE FACCTATTR like '债券利息收入%转%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KFLZ' WHERE FACCTATTR like '债券利息收入%分离%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_SMZQ' WHERE FACCTATTR like '债券利息收入%私募%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_DQRZZ' WHERE FACCTATTR like '债券利息收入%短期%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZQPJ' WHERE FACCTATTR like '债券利息收入%中期%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' WHERE FACCTATTR like '债券利息收入%企业%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_YHPJ' WHERE FACCTATTR like '债券利息收入%央行%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZCZQH' WHERE FACCTATTR like '债券利息收入%资产证券化%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--买入返售证券收入
update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ',C_SEC_VAR_CODE ='HG_ZYS',c_mkt_code = 'XSHG'  WHERE FACCTATTR like '买入%返售证券收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_mkt_code = 'XSHG' WHERE FACCTATTR like '买入%返售证券收入%' AND (FACCTNAME LIKE '%上海%' or FACCTNAME like '%上交所%' or FACCTATTR like '%上海%' or FACCTATTR like '%上交所%') AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set c_mkt_code = 'XSHE' WHERE FACCTATTR like '买入%返售证券收入%' AND (FACCTNAME LIKE '%深圳%' or FACCTNAME like '%深交所%' or FACCTATTR like '%深圳%' or FACCTATTR like '%深交所%') AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set c_mkt_code = 'XSHE' WHERE FACCTATTR like '买入%返售证券收入%' AND (FACCTNAME LIKE '%银行间%' or FACCTNAME like '%银行间%' or FACCTATTR like '%银行间%' or FACCTATTR like '%银行间%') AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  


--利息收入(委托贷款利息收入)??
--update md_km_map_temp set C_DAI_CODE  = 'LXSR_ZQ' WHERE FACCTATTR like '买入%返售证券收入' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

--更新债券品种
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_GZXQ' WHERE FACCTATTR like '债券差价收入%国债%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_CJZ' WHERE FACCTATTR like '债券差价收入%次%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_JRZ' WHERE FACCTATTR like '债券差价收入%金融%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_KZZ' WHERE FACCTATTR like '债券差价收入%转%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_SMZQ' WHERE FACCTATTR like '债券差价收入%私募%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_DQRZZ' WHERE FACCTATTR like '债券差价收入%短期%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_QYZ' WHERE FACCTATTR like '债券差价收入%企业%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_YHPJ' WHERE FACCTATTR like '债券差价收入%央行%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZCZQH' WHERE FACCTATTR like '债券差价收入%资产证券化%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_SEC_VAR_CODE ='ZQ_ZQPJ' WHERE FACCTATTR like '债券差价收入%中期票据%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
  
--其他收入
update md_km_map_temp set C_DAI_CODE  = 'QTSR' WHERE FACCTATTR like '其他收入%' AND facctclass = '损益类' {and fjjdm=:port} {and fyear=:year};
--匹配费用代码  
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where a.facctname like b.c_fee_name || '%' and b.c_src_mark = 'E') where facctattr like '其他收入%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where b.c_fee_name like a.facctname  || '%' and b.c_src_mark = 'E') 
 where facctattr like '其他收入%' and a.C_FEE_CODE is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--没有匹配上的放入“其他收入_其他”
update md_km_map_temp set C_FEE_CODE  = 'QTL_QT' WHERE FACCTATTR like '其他收入%' and trim(c_fee_code) is null AND facctclass = '损益类' {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_FEE_CODE  = 'ZQL_YHS' WHERE FACCTATTR like '其他收入%' AND FACCTNAME LIKE '%印花税%' AND facctclass = '损益类' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_FEE_CODE  = 'XSL_SHF' WHERE FACCTATTR like '其他收入%' AND FACCTNAME LIKE '%赎回费%' AND facctclass = '损益类' {and fjjdm=:port} {and fyear=:year};
--卖出回购证券支出
update md_km_map_temp set C_DAI_CODE  = 'LXZC_ZQ',C_SEC_VAR_CODE ='HG_ZYS' WHERE FACCTATTR like '卖出回购证券支出%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
--卖出回购证券支出
update md_km_map_temp set C_MKT_CODE ='XSHG' WHERE FACCTATTR like '卖出回购证券支出' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--卖出回购证券支出_深圳
update md_km_map_temp set C_MKT_CODE ='XSHE'  WHERE FACCTATTR like '卖出回购证券支出%深圳' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
--卖出回购证券支出_银行间
update md_km_map_temp set C_MKT_CODE ='XCFE'  WHERE FACCTATTR like '卖出回购证券支出%银行间' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--交易费用
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QH_GZ' WHERE FACCTATTR like '交易费用_%期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QH_SP' WHERE FACCTATTR like '交易费用_商品期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QH_QHGZ' WHERE FACCTATTR like '交易费用_国债期货' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'JJ' WHERE FACCTATTR like '交易费用_基金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'GP' WHERE FACCTATTR like '交易费用_股票%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'GP',C_MKT_CODE = 'XSHG' WHERE FACCTATTR like '交易费用_融资融券' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '交易费用_债券%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '交易费用_资产证券化%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QZ' WHERE FACCTATTR like '交易费用_权证%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'HG' WHERE FACCTATTR like '交易费用_回购%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QH' WHERE FACCTATTR like '交易费用' and facctname like '%商品期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QH_GZ',C_MKT_CODE='CCFX' WHERE FACCTATTR like '交易费用%' and (facctname like  '%股指期货%' OR FACCTATTR LIKE '%股指期货%')AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'JJ' WHERE FACCTATTR like '交易费用' and facctname like '%基金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'GP' WHERE FACCTATTR like '交易费用' and facctname like '%股票%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '交易费用' and facctname like '%债券%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'ZQ' WHERE FACCTATTR like '交易费用' and facctname like '%资产证券化%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'QZ' WHERE FACCTATTR like '交易费用' and facctname like '%权证%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_SEC_VAR_CODE = 'HG' WHERE FACCTATTR like '交易费用' and facctname like '%回购%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--更新交易费用市场代码
update md_km_map_temp set C_MKT_CODE = 'XSHG' WHERE FACCTATTR like '交易费用%' AND C_MKT_CODE IS NULL AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE = 'CCFX' WHERE FACCTATTR like '交易费用%期货%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE = 'XCFE' WHERE FACCTATTR = '交易费用_基金_开放式' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE = 'XDCE' WHERE FACCTATTR = '交易费用_商品期货_大连'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE = 'XZCE' WHERE FACCTATTR = '交易费用_商品期货_郑州'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_MKT_CODE = 'XSGE' WHERE FACCTATTR = '交易费用_商品期货_上海'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--update md_km_map_temp set C_MKT_CODE = 'SHCH' WHERE FACCTATTR LIKE '交易费用%上清所'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_MKT_CODE = 'XCFE',C_DV_INVEST_CLS = 'IC_TD' WHERE FACCTATTR like '交易费用' and facctname like '%银行%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_DAI_CODE  = 'JYFY',C_MKT_CODE = 'COTC',C_DV_INVEST_CLS = 'IC_TD' WHERE FACCTATTR like '交易费用' and facctname like '%场外%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--YYFY    运营费用 
update md_km_map_temp set C_DAI_CODE  = 'YYFY',C_FEE_CODE = 'YYL_TGF' WHERE FACCTATTR like '资产托管费' or FACCTATTR like '%年金托管费%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'YYFY',C_FEE_CODE = 'YYL_TGF' WHERE FACCTATTR like '基金托管费' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'YYFY',C_FEE_CODE = 'YYL_GLF' WHERE FACCTATTR like '管理人报酬_管理费' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set C_DAI_CODE  = 'YYFY',C_FEE_CODE = 'YYL_YJBCF' WHERE FACCTATTR like '管理人报酬_业绩报酬' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  
update md_km_map_temp set C_DAI_CODE  = 'YYFY',C_FEE_CODE = 'YYL_XSF' WHERE FACCTATTR like '基金销售费' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};  

update md_km_map_temp set c_port_cls_code = case when (facctname like '%20%' OR facctname like '%21%') then substr(facctname,-6) else '' end 
 where c_dai_code in ('YFK_YYF','YYFY') and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--分级组合容错处理
update md_km_map_temp set c_port_cls_code = '' where c_port_cls_code not in (select c_port_cls_code from t_p_aa_port_cls) and facctclass = '权益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--QTFY
--银行汇划费用(QTL_HKF)
update md_km_map_temp set C_DAI_CODE  = 'QTFY' WHERE FACCTATTR like '其他费用%'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--通配费用
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where a.facctname like b.c_fee_name || '%'  and b.c_src_mark = 'E') 
 where facctattr = '其他费用' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set a.C_FEE_CODE  = (select b.c_fee_code from T_P_BI_IE b where b.c_fee_name like a.facctname  || '%'  and b.c_src_mark = 'E') 
 where facctattr = '其他费用' and a.C_FEE_CODE is null and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_FEE_CODE  = 'YTL_SJF' WHERE FACCTATTR like '其他费用%' and facctname like '%审计费%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set C_FEE_CODE  = 'QTL_YHZHFWF' WHERE FACCTATTR like '其他费用%' and facctname like '%银行账户维护费%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_fee_code = 'ZQL_JSFWF' where FACCTATTR like '其他费用_结算服务费%'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_fee_code = 'QTL_YHZHFWF' where FACCTATTR like '其他费用_银行费用'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--SP
update md_km_map_temp set c_dai_code = 'YYFY', C_FEE_CODE  = 'YYL_YYFWF' WHERE FACCTname like '运营服务费'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 
update md_km_map_temp set c_dai_code = 'YYFY', C_FEE_CODE  = 'YYL_XSF' WHERE FACCTname like '基金销售费'  AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 

--没有匹配上的费用放入“其他费用_其他”
update md_km_map_temp set c_fee_code = 'YYL_QTF' where FACCTATTR like '其他费用%' AND trim(C_FEE_code) is null AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--投资收益_股指期货差价收入
update md_km_map_temp a set a.c_dai_code='TZSY_CJSR',a.c_sec_var_code='QH_GZ' ,C_MKT_CODE='CCFX'
 where a.c_km_code is null and a.facctattr LIKE '投资收益_股指期货差价收入%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a set a.C_DTA_CODE = 'TJ_BUY' 
 where a.c_km_code is null and a.facctattr LIKE '投资收益_股指期货差价收入_多头%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a set a.C_DTA_CODE = 'TJ_SELL' 
 where a.c_km_code is null and a.facctattr LIKE '投资收益_股指期货差价收入_空头%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--投资收益_商品期货差价收入
update md_km_map_temp a set a.c_dai_code='TZSY_CJSR',a.c_sec_var_code='QH_SP' ,C_MKT_CODE='CCFX'
 where a.c_km_code is null and a.facctattr LIKE '投资收益_商品期货差价收入%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a set a.C_DTA_CODE = 'TJ_BUY' 
 where a.c_km_code is null and a.facctattr LIKE '投资收益_商品期货差价收入_多头%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a set a.C_DTA_CODE = 'TJ_SELL' 
 where a.c_km_code is null and a.facctattr LIKE '投资收益_商品期货差价收入_空头%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--根据科目表中fby字段更新投资分类
update md_km_map_temp set c_dv_invest_cls = (case when fby = 'S' then 'IC_FS' when fby='F' then 'IC_HM' end) where fby IN('S','F') and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--银行存款去掉市场代码
update md_km_map_temp  set c_mkt_code='' where facctattr like '%银行存款%' {and fjjdm=:port} {and fyear=:year};
--待摊费用
update md_km_map_temp  set c_dai_code='DTFY' where facctattr like '%待摊费用%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_SSF' where facctattr like '%待摊费用%' and facctname like '%上市年费%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_SJF' where facctattr like '%待摊费用%' and facctname like '%审计费%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_XXPLF' where facctattr like '%待摊费用%' and facctname like '%信息披露费%' {and fjjdm=:port} {and fyear=:year};

--预提费用
update md_km_map_temp  set c_dai_code='YTFY' where facctattr like '%预提费用%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_SSF' where facctattr like '%预提费用%' and facctname like '%上市年费%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_SJF' where facctattr like '%预提费用%' and facctname like '%审计费%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YTL_XXPLF' where facctattr like '%预提费用%' and facctname like '%信息披露费%' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_fee_code='YYL_ZHGLF' where facctattr like '%预提费用%' and facctname like '%帐户管理费' {and fjjdm=:port} {and fyear=:year};

--以前年度损益调整
update md_km_map_temp  set c_dai_code='NDSYTZ' where facctattr like '%以前年度损益调整%' {and fjjdm=:port} {and fyear=:year};
--利息支出
update md_km_map_temp  set c_dai_code='LXZC_ZJ' where facctattr like '利息支出' {and fjjdm=:port} {and fyear=:year};
--存款投资
update md_km_map_temp  set c_dai_code='HBZC_CK',C_MKT_CODE = 'COTC',C_SEC_VAR_CODE = 'CK_XY',C_DV_INVEST_CLS = '' where facctattr like '存款投资_协定存款' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_dai_code='HBZC_CK',C_MKT_CODE = 'COTC',C_SEC_VAR_CODE = 'CK_DQ',C_DV_INVEST_CLS = '' where facctattr like '存款投资%定期存款' {and fjjdm=:port} {and fyear=:year};

UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select b.fcdbh||'_'||b.c_fset  from md_yhckywnew b
                        where b.c_fset=a.fset and b.fcfyhkm =a.facctcode and b.fjylb = '首期' and rownum = 1)
                          where a.FACCTATTR like '%存款投资_协定存款%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select distinct b.fcdbh||'_'||b.c_fset  from (select max(b.fcdbh) fcdbh,max(b.fcfyhkm) fcfyhkm ,b.c_fset
   	from md_yhckywnew b where  fjylb = '首期'  and rownum = 1 group by b.fcfyhkm,b.c_fset) b
           where b.c_fset=a.fset and b.fcfyhkm =a.facctcode )
                          where a.FACCTATTR like '%存款投资_定期存款%' AND a.facctclass = '资产类'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--存款投资应收利息
update md_km_map_temp  set c_dai_code = 'HBZJ',C_DV_ACC_TYPE = 'ACC_SAV',C_DV_INVEST_CLS = '' where facctattr = '存款投资_活期存款'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_dai_code = 'YSLX_ZQ',C_MKT_CODE = 'COTC',C_SEC_VAR_CODE = 'CK_XY' where facctattr like '应收利息_协定存款' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_dai_code = 'YSLX_ZQ',C_MKT_CODE = 'COTC',C_SEC_VAR_CODE = 'CK_DQ' where facctattr like '应收利息%定期存款' {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select b.fcdbh||'_'||b.c_fset  from md_yhckywnew b
                        where b.c_fset=a.fset and b.fyslxkm =a.facctcode and b.fjylb = '首期' and rownum = 1)
                          where a.FACCTATTR like '%应收利息_协定存款%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_sec_code =  (select distinct b.fcdbh||'_'||b.c_fset  from (select max(b.fcdbh) fcdbh,max(b.fyslxkm) fyslxkm ,b.c_fset
   	from md_yhckywnew b where  fjylb = '首期'  and rownum = 1 group by b.fyslxkm,b.c_fset) b
           where b.c_fset=a.fset and b.fyslxkm =a.facctcode  )
                  where a.FACCTATTR like '%应收利息%定期存款%' AND a.facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_dai_code = 'LXSR_ZQ',c_dv_acc_type = '',c_mkt_code = 'COTC'
  where facctattr = '存款利息收入_协定存款' and facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_dai_code = 'LXSR_ZQ',c_dv_acc_type = '',c_mkt_code = 'COTC'
  where facctattr = '存款利息收入_定期存款' and facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--其他应收款
update md_km_map_temp set c_dai_code = 'YSK_QTK',c_fee_code = 'QTL_QT' where facctattr like '其他应收款%' and c_km_code is null and facctclass = '资产类' {and fjjdm=:port} {and fyear=:year};
--系统BUG : JJ_KFS_HBX 会额外匹配 JJ_KFS
update md_kM_map_temp set C_KM_CODE = '1203.03.15.<SEC>'
 where facctattr LIKE '应收基金红利_开放式%' AND C_SEC_VAR_CODE = 'JJ_KFS_HBX' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.24.01.<SEC>' 
 where facctattr LIKE '基金投资_开放式%' AND C_SEC_VAR_CODE = 'JJ_KFS_HBX' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.24.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资_开放式%' AND C_SEC_VAR_CODE = 'JJ_KFS_HBX' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.13.01.<SEC>'
 where facctattr LIKE '基金投资_LOF%' AND C_SEC_VAR_CODE = 'JJ_KFS_LOF' and c_mkt_code = 'XSHE' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.13.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资_LOF' AND C_SEC_VAR_CODE = 'JJ_KFS_LOF' and c_mkt_code = 'XSHE' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.23.01.<SEC>'
 where facctattr LIKE '基金投资%LOF%' AND C_SEC_VAR_CODE = 'JJ_KFS_LOF' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.23.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资%LOF%' AND C_SEC_VAR_CODE = 'JJ_KFS_LOF' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.22.01.<SEC>'
 where facctattr LIKE '基金投资%%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'COTC' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.22.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'COTC' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.12.01.<SEC>'
 where facctattr LIKE '基金投资%%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'XSHE' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.12.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'XSHE' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.02.01.<SEC>'
 where facctattr LIKE '基金投资%%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'XSHG' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1105.02.99.<SEC>'
 where facctattr LIKE '投资估值增值_基金投资%' AND C_SEC_VAR_CODE = 'JJ_KFS_ETF' AND C_MKT_CODE = 'XSHG' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_kM_map_temp set C_KM_CODE = '1102.34.01.<SEC>'
 where facctattr LIKE '股票投资%' AND C_SEC_VAR_CODE = 'GP_GP_CYB' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_kM_map_temp set C_KM_CODE = '1102.34.99.<SEC>'
 where facctattr LIKE '投资估值增值_股票投资%' AND C_SEC_VAR_CODE = 'GP_GP_CYB' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

 update md_kM_map_temp set C_KM_CODE = '6111.08.02.<SEC>'
 where facctattr LIKE '股利收入%创业板%' AND C_SEC_VAR_CODE = 'GP_GP_CYB' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
 
 
-- 权证投资（欧式）
update md_km_map_temp  set c_dai_code = 'ZQTZ_CB',C_DV_INVEST_CLS = 'IC_TD',C_SEC_VAR_CODE = 'QZ_QZ', C_MKT_CODE = 'XSHG',C_SEC_CODE = substr(facctcode,length(facctcode)-5,6)
   where facctattr like '%权证投资%欧式%'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
 -- 权证投资（福费廷）
update md_km_map_temp  set c_dai_code = 'ZQTZ_CB',C_DV_INVEST_CLS = 'IC_TD',C_SEC_VAR_CODE = case when facctname like '%福费%' then'LC_FFY' when facctname like '%信托%' then'LC_XT' else 'LC_SYQ_QT' end 
 where facctattr = '权证投资'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp a set c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' CY'
 where facctattr = '权证投资' AND LENGTH(FACCTCODE)=14 AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

-- 基金红利收入
update md_km_map_temp  set c_dai_code = 'TZSY_HLSR',C_SEC_VAR_CODE = 'JJ' where facctattr = '保险红利收入' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

-- 保险投资
update md_km_map_temp  set C_SEC_VAR_CODE = 
 case when facctname like '%保险%' then'LC_BX' when facctname like '%信托%' then'LC_XT' else 'LC_SYQ_QT' end where facctattr = '保险投资'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
 --富国模式账户处理
 -- 更新所有的账户 c_ca_code
update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '银行存款%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '02' where FACCTATTR like '清算%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '存款利息收入%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '02' where FACCTATTR like '存款利息收入%' and facctname like '%备付金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '存款利息收入%' and facctname like '%结算保证金%' AND facctclass = '损益类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};


update md_km_map_temp  set c_ca_code = '02' where FACCTATTR like '清算%备付金%上海%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '03' where FACCTATTR like '清算%备付金%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '04' where FACCTATTR like '最低清算备付金%上海%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '05' where FACCTATTR like '最低清算备付金%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '06' where FACCTATTR like '存出保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp  set c_ca_code = '06' where FACCTATTR like '存出保证金%上海%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '07' where FACCTATTR like '存出保证金%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '08' where FACCTATTR like '交易保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '08' where FACCTATTR like '交易保证金%上海%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '09' where FACCTATTR like '交易保证金%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '结算保证金%上海%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '11' where FACCTATTR like '结算保证金%深圳%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '14' where FACCTATTR like '清算备付金%期货%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '15' where FACCTATTR like '存出保证金%期货%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '16', c_dai_code = 'HBZJ' where FACCTATTR = '存出保证金_其他' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
 update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '应收利息%' and facctname like '%存款%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '应收利息%' and facctname like '%活期利息%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp  set c_ca_code = '02' where FACCTATTR like '应收利息%' and facctname like '%上海%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '04' where FACCTATTR like '应收利息%' and facctname like '%上海%最低%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '03' where FACCTATTR like '应收利息%' and facctname like '%深圳%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '05' where FACCTATTR like '应收利息%' and facctname like '%深圳%最低%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '02' where FACCTATTR like '应收利息%' and facctname like '%上交所%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '04' where FACCTATTR like '应收利息%' and facctname like '%上交所%最低%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '03' where FACCTATTR like '应收利息%' and facctname like '%深交所%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '05' where FACCTATTR like '应收利息%' and facctname like '%深交所%最低%备付金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

--招商证券在富国基础上添加处理
update md_km_map_temp  set c_ca_code = '16',C_DAI_CODE = 'YSLX_ZJ',C_DV_INVEST_CLS = '',C_MKT_CODE = '' where FACCTATTR like '应收利息_存款投资'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '14' where FACCTATTR like '清算备付金_股指期货'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '应收利息' AND FACCTNAME = '应收托管账户利息'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '14' where FACCTATTR like '应收利息' AND FACCTNAME = '应收期货保证金利息'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '01' where FACCTATTR like '应收利息' AND FACCTNAME = '认申购款'  AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '20' ,c_dai_code = 'YFLX_ZJ',C_DV_ACC_TYPE = 'ACC_CREDIT'
  where FACCTATTR like '应付利息_股票融资' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_mkt_code = 'XSHG' WHERE FACCTATTR = '证券清算款_应收债券利息';
update md_km_map_temp set c_mkt_code = case when facctattr like '%深圳' THEN 'XSHE' ELSE 'XSHG' END  WHERE FACCTATTR LIKE '证券清算款_融资融券%';
update md_km_map_temp set C_DTA_CODE = '',c_dai_code = 'YSGJ_CDCB',C_SEC_VAR_CODE = 'QH_GZ'  
 WHERE FACCTATTR like '其他衍生工具_股指期货_冲抵' AND facctclass = '共同类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
Update md_km_map_temp set c_DAI_CODE = 'HBFZ_RZ'  WHERE FACCTATTR = '融入资金' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
Update md_km_map_temp set c_DAI_CODE = 'LXZC_RZ'  WHERE FACCTATTR = '利息支出_融资融券' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a set C_MKT_CODE = 'XDCE' ,c_SEC_VAR_CODE = 'QH_SP' ,c_sec_code = 'BB1501 DCE'
 WHERE FACCTATTR like '%其他衍生工具%' AND SUBSTR(FACCTCODE,-6) = 'BB1501'  and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_TEMP set c_dta_code = 'XY' WHERE FACCTATTR LIKE '%信用证券账户%' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
--特殊处理
update md_km_map_temp set C_DTA_CODE = 'TJ_SELL',c_dai_code = 'YSGJ_CDCB',C_SEC_VAR_CODE = 'QH_SP'  
 WHERE FACCTATTR = '其他衍生工具_股指期货_冲抵' AND facctclass = '共同类' and facctcode = '31020303BB1501' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_mkt_code = 'CCFX'
 WHERE FACCTATTR LIKE '其他衍生工具_商品期货_冲抵%' AND LENGTH(FACCTCODE)=8 AND facctclass = '共同类' {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp set c_dta_code = 'TJ_SELL' 
 where facctcode = '31020303IF1409' and c_dta_code is null {and fjjdm=:port} {and fyear=:year};

--上海席位5位，深圳席位6位
update md_km_map_TEMP set C_TD_CHAN_CODE = 
 case when facctname like '%深圳%' then substr(facctcode,9,6) else substr(facctcode,10,5)  end
 where facctattr = '应付佣金' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
UPDATE md_km_map_temp a
   SET a.c_sec_code = substr(a.facctcode,length(a.facctcode)-5,6)||' CFX'
                         where a.FACCTATTR like '其他衍生工具%' AND a.facctclass = '资产类' and a.facctlevel = '4' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};



update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '应收利息%' and facctname like '%上海%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '11' where FACCTATTR like '应收利息%' and facctname like '%深圳%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '应收利息%' and facctname like '%上交所%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '11' where FACCTATTR like '应收利息%' and facctname like '%深交所%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};

update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '交易保证金%' and facctname like '%上海%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '11' where FACCTATTR like '交易保证金%' and facctname like '%深圳%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '10' where FACCTATTR like '交易保证金%' and facctname like '%上交所%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
update md_km_map_temp  set c_ca_code = '11' where FACCTATTR like '交易保证金%' and facctname like '%深交所%结算保证金%' AND facctclass = '资产类' and c_km_Code is null {and fjjdm=:port} {and fyear=:year};
 
update md_km_map_temp a set a.c_dv_acc_type  = (select c_dv_acc_type from T_P_BI_CASH_ACC b where a.c_ca_code = b.c_ca_code) where c_km_Code is null {and fjjdm=:port} {and fyear=:year}; 